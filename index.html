<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>Malaka's Athens Trip Map</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
        }
      }
    }
  </script>

  <!-- Leaflet (CDN) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Firebase COMPAT -->
  <script src="https://www.gstatic.com/firebasejs/12.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.10.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.10.0/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --header-h: 56px;
      --clr-primary: #111827;
      --clr-accent: #10b981;
      --clr-surface: #ffffff;
      --clr-muted: #f4f4f5;
      --clr-border: #e4e4e7;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body { overflow: hidden; font-family: 'Inter', system-ui, sans-serif; }

    main {
      height: calc(100dvh - var(--header-h));
      overflow: hidden;
    }

    #map { height: 100%; }
    #map, .leaflet-container { position: relative; z-index: 0; }

    /* Custom scrollbar */
    .scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .scrollbar::-webkit-scrollbar-track { background: transparent; }
    .scrollbar::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 999px; }
    .scrollbar::-webkit-scrollbar-thumb:hover { background: #a1a1aa; }

    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .line-clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

    .soft-shadow { box-shadow: 0 1px 3px rgba(0,0,0,.06), 0 4px 12px rgba(0,0,0,.04); }
    .glass { background: rgba(255,255,255,.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
    .kbd { border: 1px solid var(--clr-border); background: var(--clr-muted); padding: 2px 6px; border-radius: 6px; font-size: 11px; font-weight: 500; }

    .btn {
      transition: all .15s ease;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active { transform: scale(0.97); }
    .btn:hover { opacity: 0.9; }

    .tag {
      display: inline-flex; align-items: center;
      border: 1px solid var(--clr-border);
      background: var(--clr-muted);
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
      color: #52525b;
    }

    .pulse-dot { animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%,100% { opacity: .4 } 50% { opacity: 1 } }

    select, input, textarea {
      background: #fff;
      color: #111827;
      border: 1.5px solid var(--clr-border);
      border-radius: 12px;
      font-family: inherit;
      font-size: 14px;
      transition: border-color .15s, box-shadow .15s;
    }
    select, input { min-height: 42px; font-weight: 500; padding: 0 12px; }
    textarea { padding: 10px 12px; font-weight: 500; }
    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: var(--clr-primary);
      box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.08);
    }

    /* Sidebar layering */
    aside { position: relative; z-index: 1300; }

    /* ONE SCROLL: sidebar scrolls, not inner sections */
    #placesList { overflow: visible !important; }
    #tab_readme > div { overflow: visible !important; }

    /* Desktop */
    @media (min-width: 1024px){
      #sidebar {
        height: 100%;
        overflow-y: auto;
        overscroll-behavior: contain;
      }
      #sidebar .sidebar-inner {
        height: auto !important;
        max-height: none !important;
      }
      .map-wrap { height: 100%; }

      /* Toggle button for sidebar on mobile */
      .mobile-toggle-bar { display: none !important; }
    }

    /* Mobile: sidebar is full screen panel, togglable */
    @media (max-width: 1023px){
      #sidebar {
        position: fixed;
        top: var(--header-h);
        bottom: 0;
        left: 0;
        right: 0;
        height: auto;
        max-height: none;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
        border-radius: 0;
        box-shadow: none;
        z-index: 1300;
        transition: transform .3s ease;
      }
      #sidebar.sidebar-hidden {
        transform: translateY(100%);
        pointer-events: none;
      }
      .map-wrap { height: 100%; }
    }

    /* Heart / Pin icon buttons */
    .icon-btn {
      display: inline-flex; align-items: center; justify-content: center;
      width: 34px; height: 34px;
      border-radius: 10px;
      border: 1.5px solid var(--clr-border);
      background: #fff;
      font-size: 16px;
      line-height: 1;
      cursor: pointer;
      transition: all .15s ease;
      -webkit-tap-highlight-color: transparent;
      flex-shrink: 0;
    }
    .icon-btn:hover { background: var(--clr-muted); }
    .icon-btn:active { transform: scale(0.92); }
    .icon-btn.active-heart {
      background: #fef2f2;
      border-color: #fca5a5;
      color: #dc2626;
    }
    .icon-btn.active-pin {
      background: #eff6ff;
      border-color: #93c5fd;
      color: #2563eb;
    }

    /* Place card */
    .place-card {
      padding: 14px;
      border-radius: 16px;
      border: 1.5px solid var(--clr-border);
      background: #fff;
      transition: box-shadow .15s ease, border-color .15s ease;
    }
    .place-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      border-color: #d4d4d8;
    }

    /* Toast */
    .toast-item {
      pointer-events: none;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--clr-border);
      border-radius: 12px;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 500;
      color: #18181b;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
      animation: toastIn .3s ease;
    }
    @keyframes toastIn { from { opacity:0; transform: translateY(-8px); } to { opacity:1; transform: translateY(0); } }

    /* Mobile toggle bar at bottom */
    .mobile-toggle-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 1400;
      display: flex;
      justify-content: center;
      padding: 8px 16px;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-top: 1px solid var(--clr-border);
    }

    /* Leaflet popup overrides */
    .leaflet-popup-content-wrapper {
      border-radius: 16px !important;
      box-shadow: 0 4px 16px rgba(0,0,0,.12) !important;
    }
    .leaflet-popup-content { margin: 12px 14px !important; }
  </style>
</head>

<body class="bg-zinc-50 text-zinc-900 font-sans">

  <!-- Top bar -->
  <header class="h-[56px] px-4 border-b bg-white/90 backdrop-blur-md sticky top-0 z-[1100]" style="height: var(--header-h);">
    <div class="h-full flex items-center gap-3 max-w-[1800px] mx-auto">
      <div class="w-9 h-9 rounded-xl bg-zinc-900 text-white flex items-center justify-center font-bold text-sm">M</div>
      <div class="min-w-0">
        <div class="font-semibold text-sm leading-tight truncate">Malaka's Athens Trip</div>
        <div class="text-[11px] text-zinc-400 leading-tight truncate">Italians in Greece</div>
      </div>

      <div class="ml-auto flex items-center gap-1.5 sm:gap-2">
        <div id="cloudStatus" class="hidden sm:flex items-center gap-1.5 px-2.5 py-1.5 rounded-xl border bg-white text-xs">
          <span id="cloudDot" class="w-1.5 h-1.5 rounded-full bg-zinc-300"></span>
          <span id="cloudText" class="text-zinc-500">Cloud: off</span>
        </div>

        <button id="btnFolders" class="btn px-3 py-1.5 rounded-xl border bg-white hover:bg-zinc-50 text-xs font-medium">Folders</button>
        <button id="btnReset" class="btn px-3 py-1.5 rounded-xl border bg-white hover:bg-red-50 text-xs font-medium text-red-600 hidden sm:inline-flex">Reset</button>
      </div>
    </div>
  </header>

  <!-- Layout -->
  <main class="relative lg:grid lg:grid-cols-[440px_1fr]">
    <!-- Sidebar -->
    <aside id="sidebar"
      class="bg-white lg:border-r scrollbar
             lg:static
             z-[1300]
             lg:rounded-none
             lg:shadow-none">

      <div class="sidebar-inner p-4 pb-24 lg:pb-6">
        <!-- Action buttons -->
        <div class="grid grid-cols-2 gap-2">
          <button id="btnAddPlace" class="btn flex items-center justify-center gap-1.5 px-4 py-2.5 rounded-xl bg-zinc-900 text-white text-sm font-medium hover:bg-zinc-800">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add place
          </button>
          <button id="btnAddFolder" class="btn flex items-center justify-center gap-1.5 px-4 py-2.5 rounded-xl border bg-white text-sm font-medium hover:bg-zinc-50">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
            Folder
          </button>
        </div>

        <!-- Tabs -->
        <div class="mt-3 flex gap-1.5 p-1 rounded-xl bg-zinc-100">
          <button data-tab="places" class="tabBtn flex-1 btn px-3 py-2 rounded-lg bg-white text-sm font-medium shadow-sm">Places</button>
          <button data-tab="readme" class="tabBtn flex-1 btn px-3 py-2 rounded-lg text-sm font-medium text-zinc-500 hover:text-zinc-700">Guide</button>
        </div>

        <!-- My Places search -->
        <div class="mt-3 p-3.5 rounded-2xl border bg-zinc-50/80">
          <div class="flex items-center justify-between mb-2">
            <div class="text-[11px] font-medium text-zinc-500 uppercase tracking-wider">Search My places</div>
            <div class="text-[11px] text-zinc-400">Clear <span class="kbd">Esc</span></div>
          </div>

          <div class="flex gap-2">
            <input id="searchText" class="w-full px-3 py-2 text-sm"
              placeholder="e.g. acropolis, brunch, rooftop..." />
            <button id="btnClearSearch" class="btn px-3 py-2 rounded-xl border bg-white text-xs font-medium hover:bg-zinc-50">Clear</button>
          </div>

          <div class="mt-2 grid grid-cols-2 gap-2">
            <select id="filterFolder" class="w-full px-3 py-2 text-sm"></select>
            <select id="filterCategory" class="w-full px-3 py-2 text-sm"></select>
          </div>

          <div class="mt-2 grid grid-cols-2 gap-2">
            <button id="btnOnlyHearts" class="btn flex items-center justify-center gap-1.5 px-3 py-2 rounded-xl border bg-white text-sm font-medium hover:bg-zinc-50">
              <span class="text-base">&#9829;</span> Shortlist
            </button>
            <button id="btnOnlyPinned" class="btn flex items-center justify-center gap-1.5 px-3 py-2 rounded-xl border bg-white text-sm font-medium hover:bg-zinc-50">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M16 2a1 1 0 0 1 .7.3l5 5a1 1 0 0 1-.2 1.4l-4.5 3V16a1 1 0 0 1-.3.7l-3 3a1 1 0 0 1-1.7-.7v-5.6L8.4 9.8H4a1 1 0 0 1-.7-1.7l3-3A1 1 0 0 1 7 5h4.3l3-4.5A1 1 0 0 1 16 2z"/></svg>
              Must-do
            </button>
          </div>
        </div>

        <!-- Map search (POI) -->
        <div class="mt-3 p-3.5 rounded-2xl border bg-white soft-shadow">
          <div class="flex items-center gap-2 mb-2">
            <div class="w-2 h-2 rounded-full bg-emerald-500 pulse-dot"></div>
            <div class="text-[11px] font-medium text-zinc-500 uppercase tracking-wider">Search Athens (Map)</div>
          </div>

          <div class="flex gap-2">
            <input id="poiQuery" class="w-full px-3 py-2 text-sm"
              placeholder="Search by place name..." />
            <button id="btnPoi" class="btn px-4 py-2 rounded-xl bg-zinc-900 text-white text-sm font-medium">Search</button>
          </div>

          <div class="mt-1.5 flex items-center text-[11px] text-zinc-400 gap-2">
            <span>Click <b class="text-zinc-600">Add</b> to pin.</span>
            <button id="btnPoiClear" class="btn ml-auto underline hover:text-zinc-600">Clear</button>
          </div>

          <div id="poiResults" class="hidden mt-2 border rounded-2xl bg-white overflow-auto scrollbar max-h-56"></div>
        </div>

        <!-- Tab content -->
        <div class="mt-4">
          <!-- PLACES -->
          <section id="tab_places" class="pb-5">
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-semibold">My places</div>
              <div id="placesCount" class="text-xs text-zinc-400 font-medium"></div>
            </div>
            <div id="placesList" class="space-y-2.5"></div>
          </section>

          <!-- README -->
          <section id="tab_readme" class="hidden pb-5">
            <div class="space-y-3">
              <div class="p-4 rounded-2xl border bg-white soft-shadow">
                <div class="text-base font-bold">Guide</div>
                <div class="text-xs text-zinc-500 mt-0.5">Tips for your Athens trip</div>

                <div class="mt-3 space-y-2.5 text-sm">
                  <div class="p-3.5 rounded-xl bg-zinc-50 border">
                    <div class="font-semibold">Bring your sunscreen!</div>
                    <div class="text-zinc-600 mt-1.5 leading-relaxed">
                      Use this as a <b>light suggestion</b> &mdash; it's totally up to you what you'll plan and how packed (or chill).
                    </div>
                    <ul class="mt-2 space-y-1.5 text-zinc-600 leading-relaxed">
                      <li class="flex gap-2"><span class="font-semibold shrink-0">Morning:</span> brunch/breakfast this time of the year and museum visits.</li>
                      <li class="flex gap-2"><span class="font-semibold shrink-0">Lunch:</span> check if the place you see is super crowded &mdash; might need a small reservation if it's more fancy.</li>
                      <li class="flex gap-2"><span class="font-semibold shrink-0">Afternoon:</span> Acropolis museum a must in the evening when sun goes down. There's a terrace up from museum but super expensive (tourist trap).</li>
                      <li class="flex gap-2"><span class="font-semibold shrink-0">Night:</span> we eat late dinners, so not 6pm ahhah but you are Italians so you get the vibe.</li>
                    </ul>
                  </div>
                </div>
              </div>

              <div class="p-4 rounded-2xl border bg-white soft-shadow">
                <div class="text-base font-bold">Transport (city + airport)</div>
                <div class="text-xs text-zinc-500 mt-0.5">Prices from the sites, double-check in case of changes.</div>

                <div class="mt-3 space-y-2.5 text-sm">
                  <div class="p-3.5 rounded-xl bg-zinc-50 border">
                    <div class="font-semibold">City tickets</div>
                    <ul class="mt-2 space-y-1 text-zinc-600">
                      <li>90-minute: <b>&euro;1.20</b></li>
                      <li>24-hour: <b>&euro;4.10</b></li>
                      <li class="text-zinc-500 text-xs">(Check upon arrival just in case they increased it.)</li>
                    </ul>
                    <div class="mt-2">
                      <a class="text-xs font-medium text-zinc-900 underline underline-offset-2" target="_blank" rel="noreferrer" href="https://www.oasa.gr/en/tickets/prices-of-products/">OASA official prices</a>
                    </div>
                  </div>

                  <div class="p-3.5 rounded-xl bg-zinc-50 border">
                    <div class="font-semibold">Airport &harr; City</div>
                    <ul class="mt-2 space-y-1 text-zinc-600">
                      <li>Metro airport: <b>&euro;9</b> one-way, <b>&euro;16</b> two-way</li>
                      <li>Airport Express bus: <b>&euro;5.50</b> one-way</li>
                      <li>Taxi flat fare (center): <b>&euro;40</b> day / <b>&euro;55</b> night</li>
                    </ul>
                    <div class="mt-2 flex flex-wrap gap-3">
                      <a class="text-xs font-medium text-zinc-900 underline underline-offset-2" target="_blank" rel="noreferrer" href="https://www.oasa.gr/en/tickets/prices-of-products/">OASA prices</a>
                      <a class="text-xs font-medium text-zinc-900 underline underline-offset-2" target="_blank" rel="noreferrer" href="https://www.oasa.gr/en/visit-athens/airport-express-bus-lines/">Airport Express lines</a>
                      <a class="text-xs font-medium text-zinc-900 underline underline-offset-2" target="_blank" rel="noreferrer" href="https://www.aia.gr/en/traveller/transportation-airport/taxi-limousines-transfer">AIA taxi fares</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
      </div>
    </aside>

    <!-- Map -->
    <section class="relative bg-zinc-100 map-wrap">
      <div id="map"></div>

      <div class="absolute bottom-4 left-4 glass border rounded-2xl soft-shadow px-3 py-2 text-xs text-zinc-600 hidden lg:block">
        Tip: click the map to auto-fill coordinates in "Add place".
      </div>

      <!-- Toasts -->
      <div id="toastArea" class="absolute top-4 right-4 z-[1200] space-y-2 pointer-events-none"></div>
    </section>
  </main>

  <!-- Mobile toggle bar -->
  <div class="mobile-toggle-bar lg:hidden">
    <div class="flex gap-2 w-full max-w-md">
      <button id="mobileShowSidebar" class="btn flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-xl bg-zinc-900 text-white text-sm font-medium">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        Places
      </button>
      <button id="mobileShowMap" class="btn flex-1 flex items-center justify-center gap-1.5 py-2.5 rounded-xl border bg-white text-sm font-medium">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
        Map
      </button>
    </div>
  </div>

  <!-- Modal: Add/Edit Place -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/40 backdrop-blur-sm p-4 z-[2000]">
    <div class="w-full max-w-2xl max-h-[90vh] bg-white rounded-2xl soft-shadow border overflow-hidden flex flex-col">
      <div class="px-5 py-3.5 border-b flex items-center gap-2 shrink-0">
        <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
        <div id="modalTitle" class="font-semibold text-sm">Add place</div>
        <button id="btnCloseModal" class="btn ml-auto px-3 py-1.5 rounded-xl border bg-white text-xs font-medium hover:bg-zinc-50">Close</button>
      </div>

      <div class="p-5 space-y-4 overflow-y-auto">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="text-[11px] font-medium text-zinc-500 uppercase tracking-wider">Name</label>
            <input id="fName" class="w-full mt-1 px-3 py-2.5 text-sm" placeholder="Place name" />
          </div>

          <div>
            <label class="text-[11px] font-medium text-zinc-500 uppercase tracking-wider">Category</label>
            <select id="fCategory" class="w-full mt-1 px-3 py-2.5 text-sm"></select>
          </div>

          <div>
            <label class="text-[11px] font-medium text-zinc-500 uppercase tracking-wider">Folder</label>
            <select id="fFolder" class="w-full mt-1 px-3 py-2.5 text-sm"></select>
          </div>

          <div>
            <label class="text-[11px] font-medium text-zinc-500 uppercase tracking-wider">Neighborhood / vibe</label>
            <input id="fVibe" class="w-full mt-1 px-3 py-2.5 text-sm" placeholder="e.g. chill street, rooftop view..." />
          </div>

          <div>
            <label class="text-[11px] font-medium text-zinc-500 uppercase tracking-wider">Latitude</label>
            <input id="fLat" class="w-full mt-1 px-3 py-2.5 text-sm" placeholder="Click map to fill" />
          </div>

          <div>
            <label class="text-[11px] font-medium text-zinc-500 uppercase tracking-wider">Longitude</label>
            <input id="fLng" class="w-full mt-1 px-3 py-2.5 text-sm" placeholder="Click map to fill" />
          </div>

          <div class="md:col-span-2">
            <label class="text-[11px] font-medium text-zinc-500 uppercase tracking-wider">Description</label>
            <textarea id="fDesc" class="w-full mt-1 px-3 py-2.5 text-sm" rows="3" placeholder="What to do/order, best time, notes..."></textarea>
          </div>

          <div>
            <label class="text-[11px] font-medium text-zinc-500 uppercase tracking-wider">Website link</label>
            <input id="fLink" class="w-full mt-1 px-3 py-2.5 text-sm" placeholder="https://..." />
          </div>

          <div>
            <label class="text-[11px] font-medium text-zinc-500 uppercase tracking-wider">Google Maps link</label>
            <input id="fGmaps" class="w-full mt-1 px-3 py-2.5 text-sm" placeholder="https://maps.google.com/..." />
          </div>

          <div class="md:col-span-2">
            <label class="text-[11px] font-medium text-zinc-500 uppercase tracking-wider">Photo URLs (comma-separated)</label>
            <input id="fPhotos" class="w-full mt-1 px-3 py-2.5 text-sm" placeholder="https://...jpg, https://...png" />
            <div class="text-[11px] text-zinc-400 mt-1">Tip: you can host images in your repo and use relative paths.</div>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <button id="btnSavePlace" class="btn px-5 py-2.5 rounded-xl bg-zinc-900 text-white text-sm font-medium">Save</button>
          <button id="btnDeletePlace" class="btn px-4 py-2.5 rounded-xl border bg-white text-sm font-medium text-red-600 hover:bg-red-50 hidden">Delete</button>

          <div class="ml-auto flex items-center gap-4 text-sm">
            <label class="flex items-center gap-2 cursor-pointer">
              <input id="fFav" type="checkbox" class="accent-red-500 w-4 h-4" />
              <span class="font-medium">Shortlist</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input id="fPinned" type="checkbox" class="accent-blue-600 w-4 h-4" />
              <span class="font-medium">Must-do</span>
            </label>
          </div>
        </div>

        <div class="text-[11px] text-zinc-400">Map tiles: OpenStreetMap | POI: Nominatim | Sync: Firebase</div>
      </div>
    </div>
  </div>

  <!-- Modal: Folder Manager -->
  <div id="folderModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 backdrop-blur-sm p-4 z-[2000]">
    <div class="w-full max-w-md max-h-[85vh] bg-white rounded-2xl soft-shadow border overflow-hidden flex flex-col">
      <div class="px-5 py-3.5 border-b flex items-center shrink-0">
        <div class="font-semibold text-sm">Folders</div>
        <button id="btnCloseFolderModal" class="btn ml-auto px-3 py-1.5 rounded-xl border bg-white text-xs font-medium hover:bg-zinc-50">Close</button>
      </div>

      <div class="p-5 space-y-4 overflow-y-auto">
        <div class="p-3.5 rounded-2xl bg-zinc-50 border">
          <div class="text-xs font-semibold mb-2">Create folder</div>
          <div class="flex gap-2">
            <input id="newFolderName" class="flex-1 px-3 py-2 text-sm" placeholder="Folder name..." />
            <button id="btnCreateFolder" class="btn px-4 py-2 rounded-xl bg-zinc-900 text-white text-xs font-medium">Create</button>
          </div>
          <div class="text-[11px] text-zinc-400 mt-2">You can delete <b>any</b> folder. Places will be moved to another folder you choose.</div>
        </div>

        <div>
          <div class="text-xs font-semibold mb-2">Your folders</div>
          <div id="folderList" class="space-y-2 max-h-[40vh] overflow-auto scrollbar"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Delete folder + move places -->
  <div id="deleteFolderModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 backdrop-blur-sm p-4 z-[2500]">
    <div class="w-full max-w-md bg-white rounded-2xl soft-shadow border overflow-hidden">
      <div class="px-5 py-3.5 border-b flex items-center">
        <div class="font-semibold text-sm">Delete folder</div>
        <button id="btnCloseDeleteFolderModal" class="btn ml-auto px-3 py-1.5 rounded-xl border bg-white text-xs font-medium hover:bg-zinc-50">Close</button>
      </div>
      <div class="p-5 space-y-4">
        <div class="text-sm text-zinc-700">
          You're deleting: <b id="delFolderName">&mdash;</b>
        </div>

        <div class="p-3.5 rounded-2xl bg-zinc-50 border">
          <div class="text-xs font-semibold">Move its places to</div>
          <select id="delMoveTo" class="mt-2 w-full px-3 py-2.5 text-sm"></select>
          <div class="text-[11px] text-zinc-400 mt-2">
            If this is your last folder, the app will create <b>My places</b> automatically.
          </div>
        </div>

        <div class="flex gap-2">
          <button id="btnConfirmDeleteFolder" class="btn px-4 py-2.5 rounded-xl bg-red-600 text-white text-sm font-medium">Delete</button>
          <button id="btnCancelDeleteFolder" class="btn px-4 py-2.5 rounded-xl border bg-white text-sm font-medium hover:bg-zinc-50">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      /***********************
       *  CONFIG
       ***********************/
      const STORAGE_KEY = "athens_trip_app_cloud_modern_v1";

      const STORAGE_KEY_FALLBACKS = [
        "athens_trip_app_cloud_modern_v1",
        "athens_trip_app_v1",
        "athens_trip_app_v2",
        "athens_trip_app_cloud_v1",
        "athens_trip_app_cloud_modern",
        "athens_trip_app"
      ];

      const CLIENT_ID_KEY = "athens_trip_client_id_v1";
      const DEFAULT_TRIP_ID = "athens-3days";
      const urlParams = new URLSearchParams(location.search);
      const TRIP_ID = (urlParams.get("trip") || DEFAULT_TRIP_ID).trim();

      const DEFAULT_FOLDER_FAV = "Malaka's favorites";

      const CATEGORIES = [
        "Brunch","Lunch","Dinner","Drinks","Coffee",
        "Museum","Historical","Park","Viewpoint",
        "Shopping","Bakery/Dessert","Beach/Day trip","Other"
      ];

      function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
      function b2n(v){ return v ? 1 : 0; }
      function nowMs(){ return Date.now(); }

      function safeClone(obj){
        return (typeof structuredClone === "function")
          ? structuredClone(obj)
          : JSON.parse(JSON.stringify(obj));
      }

      function getClientId(){
        let id = localStorage.getItem(CLIENT_ID_KEY);
        if(!id){
          id = "c_" + uid();
          localStorage.setItem(CLIENT_ID_KEY, id);
        }
        return id;
      }
      const CLIENT_ID = getClientId();

      /***********************
       *  FIREBASE CONFIG
       ***********************/
      const firebaseConfig = {
        apiKey: "AIzaSyA4d4KIauh_bj9gKwd9prTbTJPDw_tGi4c",
        authDomain: "malakas-athens-trip.firebaseapp.com",
        projectId: "malakas-athens-trip",
        storageBucket: "malakas-athens-trip.firebasestorage.app",
        messagingSenderId: "731335410840",
        appId: "1:731335410840:web:77ba6b8d6e75ed01ab3ced"
      };

      /***********************
       *  DEFAULT STATE
       ***********************/
      const defaultState = {
        meta: { updatedAtMs: 0, updatedBy: "", tripId: TRIP_ID },
        folders: [
          { id: "f_malakas", name: DEFAULT_FOLDER_FAV },
          { id: "f_general", name: "Other suggestions" }
        ],
        places: [
          {
            id: uid(),
            name: "Acropolis / Parthenon",
            category: "Historical",
            folderId: "f_general",
            vibe: "Iconic - go early to avoid crowds",
            desc: "Must-see. Combine with Acropolis Museum after.",
            lat: 37.9715, lng: 23.7267,
            link: "",
            gmaps: "https://maps.google.com/?q=Acropolis+of+Athens",
            photos: [],
            favorite: true,
            pinned: true
          },
          {
            id: uid(),
            name: "National Garden",
            category: "Park",
            folderId: "f_general",
            vibe: "Chill walk near Syntagma",
            desc: "Good reset spot, shade, quick stroll.",
            lat: 37.9731, lng: 23.7365,
            link: "",
            gmaps: "https://maps.google.com/?q=National+Garden+Athens",
            photos: [],
            favorite: false,
            pinned: false
          }
        ],
        itinerary: [],
        ui: { heartsOnly: false, pinnedOnly: false }
      };

      function loadStateFromAnyKey(){
        for(const k of STORAGE_KEY_FALLBACKS){
          try{
            const raw = localStorage.getItem(k);
            if(!raw) continue;
            const parsed = JSON.parse(raw);
            if(parsed && typeof parsed === "object") return { state: parsed, key: k };
          }catch(_){}
        }
        return { state: null, key: null };
      }

      function normalizeState(s){
        s = s || safeClone(defaultState);
        s.meta ??= { updatedAtMs: 0, updatedBy: "", tripId: TRIP_ID };
        s.folders ??= safeClone(defaultState.folders);
        s.places ??= safeClone(defaultState.places);
        s.itinerary ??= [];
        s.ui ??= { heartsOnly:false, pinnedOnly:false };

        if(!Array.isArray(s.folders) || s.folders.length === 0){
          s.folders = [{ id:"f_my_"+uid(), name:"My places" }];
        }
        if(!Array.isArray(s.places)) s.places = [];
        if(!Array.isArray(s.itinerary)) s.itinerary = [];
        s.meta.tripId = TRIP_ID;
        return s;
      }

      const loaded = loadStateFromAnyKey();
      let state = normalizeState(loaded.state || null);

      if(loaded.key && loaded.key !== STORAGE_KEY){
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(_){}
      }

      function ensureAtLeastOneFolder(){
        if(!Array.isArray(state.folders) || state.folders.length === 0){
          state.folders = [{ id:"f_my_"+uid(), name:"My places" }];
        }
      }

      function saveLocal(){
        try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(_){}
      }

      /***********************
       *  TOASTS + HELPERS
       ***********************/
      const toastArea = document.getElementById("toastArea");
      function toast(message){
        if(!toastArea) return;
        const el = document.createElement("div");
        el.className = "toast-item";
        el.textContent = message;
        toastArea.appendChild(el);
        setTimeout(() => { el.style.opacity = "0"; el.style.transition = "opacity .3s ease"; }, 1800);
        setTimeout(() => { el.remove(); }, 2200);
      }

      function folderName(folderId){
        return (state.folders.find(f => f.id === folderId)?.name) || "Unsorted";
      }
      function escapeHtml(str){
        return String(str ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }
      function escapeAttr(str){ return escapeHtml(str); }
      function googleMapsLatLng(lat,lng){
        return `https://maps.google.com/?q=${encodeURIComponent(lat + "," + lng)}`;
      }

      /***********************
       *  UI REFS
       ***********************/
      const placesListEl = document.getElementById("placesList");
      const placesCountEl = document.getElementById("placesCount");

      const filterFolderEl = document.getElementById("filterFolder");
      const filterCategoryEl = document.getElementById("filterCategory");
      const searchTextEl = document.getElementById("searchText");
      const btnOnlyHearts = document.getElementById("btnOnlyHearts");
      const btnOnlyPinned = document.getElementById("btnOnlyPinned");

      const poiQueryEl = document.getElementById("poiQuery");
      const btnPoiEl = document.getElementById("btnPoi");
      const btnPoiClearEl = document.getElementById("btnPoiClear");
      const poiResultsEl = document.getElementById("poiResults");

      /***********************
       *  MOBILE SIDEBAR TOGGLE
       ***********************/
      const sidebar = document.getElementById("sidebar");
      const mobileShowSidebar = document.getElementById("mobileShowSidebar");
      const mobileShowMap = document.getElementById("mobileShowMap");

      function showSidebar(){
        sidebar.classList.remove("sidebar-hidden");
        mobileShowSidebar.classList.remove("border","bg-white");
        mobileShowSidebar.classList.add("bg-zinc-900","text-white");
        mobileShowMap.classList.remove("bg-zinc-900","text-white");
        mobileShowMap.classList.add("border","bg-white");
      }
      function hideSidebar(){
        sidebar.classList.add("sidebar-hidden");
        mobileShowMap.classList.remove("border","bg-white");
        mobileShowMap.classList.add("bg-zinc-900","text-white");
        mobileShowSidebar.classList.remove("bg-zinc-900","text-white");
        mobileShowSidebar.classList.add("border","bg-white");
        setTimeout(() => map.invalidateSize(), 350);
      }

      if(mobileShowSidebar) mobileShowSidebar.addEventListener("click", showSidebar);
      if(mobileShowMap) mobileShowMap.addEventListener("click", hideSidebar);

      /***********************
       *  CLOUD UI
       ***********************/
      const cloudStatusEl = document.getElementById("cloudStatus");
      const cloudDotEl = document.getElementById("cloudDot");
      const cloudTextEl = document.getElementById("cloudText");

      function setCloudUI(mode, text){
        if(!cloudStatusEl || !cloudDotEl || !cloudTextEl) return;
        cloudStatusEl.classList.remove("hidden");
        cloudStatusEl.classList.add("sm:flex");
        cloudTextEl.textContent = text;

        cloudDotEl.classList.remove("bg-zinc-300","bg-emerald-500","bg-amber-500","bg-red-500");
        if(mode === "on") cloudDotEl.classList.add("bg-emerald-500");
        else if(mode === "syncing") cloudDotEl.classList.add("bg-amber-500");
        else if(mode === "error") cloudDotEl.classList.add("bg-red-500");
        else cloudDotEl.classList.add("bg-zinc-300");
      }

      /***********************
       *  MAP
       ***********************/
      const map = L.map("map", { zoomControl: true }).setView([37.9838, 23.7275], 13);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      const markersLayer = L.layerGroup().addTo(map);
      const poiLayer = L.layerGroup().addTo(map);

      setTimeout(() => map.invalidateSize(), 250);
      window.addEventListener("resize", () => map.invalidateSize());

      map.on("click", (e) => {
        const lat = document.getElementById("fLat");
        const lng = document.getElementById("fLng");
        if(lat) lat.value = e.latlng.lat.toFixed(6);
        if(lng) lng.value = e.latlng.lng.toFixed(6);
        toast("Coordinates filled from map click.");
      });

      /***********************
       *  FILTERED PLACES
       ***********************/
      function filteredPlaces(){
        const folder = filterFolderEl?.value || "__all__";
        const cat = filterCategoryEl?.value || "__all__";
        const q = (searchTextEl?.value || "").trim().toLowerCase();

        return state.places
          .filter(p => folder === "__all__" ? true : p.folderId === folder)
          .filter(p => cat === "__all__" ? true : p.category === cat)
          .filter(p => state.ui.heartsOnly ? !!p.favorite : true)
          .filter(p => state.ui.pinnedOnly ? !!p.pinned : true)
          .filter(p => {
            if(!q) return true;
            const hay = [p.name, p.category, folderName(p.folderId), p.vibe, p.desc].join(" ").toLowerCase();
            return hay.includes(q);
          })
          .sort((a,b) => {
            const score = (b2n(b.pinned) - b2n(a.pinned)) || (b2n(b.favorite) - b2n(a.favorite));
            if(score) return score;
            return (a.name||"").localeCompare(b.name||"");
          });
      }

      /***********************
       *  HEART / PIN SVG ICONS
       ***********************/
      const HEART_EMPTY = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>';
      const HEART_FILLED = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>';
      const PIN_EMPTY = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>';
      const PIN_FILLED = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3" fill="white"/></svg>';

      /***********************
       *  MARKERS + LIST
       ***********************/
      function makePopupHTML(place){
        const photos = (place.photos || []).filter(Boolean);
        const photoHTML = photos.length
          ? `<img src="${escapeHtml(photos[0])}" alt="" style="width:100%;height:120px;object-fit:cover;border-radius:12px;margin-bottom:8px;" onerror="this.style.display='none'">`
          : "";

        const links = `
          <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;font-size:12px;">
            ${place.gmaps ? `<a target="_blank" rel="noreferrer" style="text-decoration:underline;" href="${escapeAttr(place.gmaps)}">Google Maps</a>` : ""}
            ${place.link ? `<a target="_blank" rel="noreferrer" style="text-decoration:underline;" href="${escapeAttr(place.link)}">Website</a>` : ""}
          </div>
        `;

        return `
          <div style="width:260px;font-family:Inter,system-ui,sans-serif;">
            ${photoHTML}
            <div style="font-weight:600;font-size:14px;">${escapeHtml(place.name || "Untitled")}</div>
            <div style="font-size:11px;color:#71717a;margin-top:2px;">${escapeHtml(place.category || "Other")} &bull; ${escapeHtml(folderName(place.folderId))}</div>
            ${place.vibe ? `<div style="font-size:11px;margin-top:4px;">${escapeHtml(place.vibe)}</div>` : ""}
            ${place.desc ? `<div style="font-size:11px;margin-top:4px;color:#52525b;">${escapeHtml(place.desc)}</div>` : ""}
            ${links}
            <div style="display:flex;gap:6px;margin-top:10px;">
              <button style="padding:4px 10px;border-radius:8px;border:1px solid #e4e4e7;font-size:11px;background:#fff;cursor:pointer;" onclick="window.toggleFavorite('${place.id}')">${place.favorite ? "Unheart" : "Heart"}</button>
              <button style="padding:4px 10px;border-radius:8px;border:1px solid #e4e4e7;font-size:11px;background:#fff;cursor:pointer;" onclick="window.togglePinned('${place.id}')">${place.pinned ? "Unpin" : "Pin"}</button>
              <button style="padding:4px 10px;border-radius:8px;border:1px solid #e4e4e7;font-size:11px;background:#fff;cursor:pointer;" onclick="window.openEdit('${place.id}')">Edit</button>
            </div>
          </div>
        `;
      }

      function renderMarkers(){
        markersLayer.clearLayers();
        filteredPlaces().forEach(p => {
          if(!isFinite(p.lat) || !isFinite(p.lng)) return;
          const m = L.marker([p.lat, p.lng]).addTo(markersLayer);
          m.bindPopup(makePopupHTML(p));
        });
      }

      function placeCard(place){
        const photos = (place.photos || []).filter(Boolean);
        const thumb = photos[0];

        const heartClass = place.favorite ? "icon-btn active-heart" : "icon-btn";
        const heartIcon = place.favorite ? HEART_FILLED : HEART_EMPTY;
        const pinClass = place.pinned ? "icon-btn active-pin" : "icon-btn";
        const pinIcon = place.pinned ? PIN_FILLED : PIN_EMPTY;

        return `
          <div class="place-card">
            <div class="flex gap-3">
              <div class="w-16 h-16 sm:w-20 sm:h-20 rounded-xl border bg-zinc-100 overflow-hidden flex items-center justify-center text-[10px] text-zinc-400 shrink-0">
                ${thumb ? `<img src="${escapeAttr(thumb)}" class="w-full h-full object-cover" onerror="this.parentElement.textContent='No photo'">` : "No photo"}
              </div>

              <div class="min-w-0 flex-1">
                <div class="flex items-start gap-2">
                  <div class="font-semibold text-sm truncate flex-1">${escapeHtml(place.name || "Untitled")}</div>
                  <div class="flex items-center gap-1.5 shrink-0">
                    <button class="${heartClass}" onclick="window.toggleFavorite('${place.id}')" title="${place.favorite ? 'Remove from shortlist' : 'Add to shortlist'}">${heartIcon}</button>
                    <button class="${pinClass}" onclick="window.togglePinned('${place.id}')" title="${place.pinned ? 'Unpin' : 'Pin as must-do'}">${pinIcon}</button>
                  </div>
                </div>

                <div class="text-[11px] text-zinc-500 mt-0.5 font-medium">
                  ${escapeHtml(place.category || "Other")} &bull; ${escapeHtml(folderName(place.folderId))}
                </div>

                ${place.vibe ? `<div class="text-xs text-zinc-600 mt-1.5 line-clamp-2">${escapeHtml(place.vibe)}</div>` : ""}

                <div class="flex flex-wrap gap-1.5 mt-2">
                  <button class="btn px-2.5 py-1 rounded-lg border text-[11px] font-medium hover:bg-zinc-50" onclick="window.flyToPlace('${place.id}')">View</button>
                  <button class="btn px-2.5 py-1 rounded-lg border text-[11px] font-medium hover:bg-zinc-50" onclick="window.openEdit('${place.id}')">Edit</button>
                  ${place.gmaps ? `<a class="btn px-2.5 py-1 rounded-lg border text-[11px] font-medium hover:bg-zinc-50 inline-flex items-center" target="_blank" rel="noreferrer" href="${escapeAttr(place.gmaps)}">Maps</a>` : ""}
                  ${place.link ? `<a class="btn px-2.5 py-1 rounded-lg border text-[11px] font-medium hover:bg-zinc-50 inline-flex items-center" target="_blank" rel="noreferrer" href="${escapeAttr(place.link)}">Link</a>` : ""}
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function renderPlacesList(){
        const items = filteredPlaces();
        if(placesCountEl) placesCountEl.textContent = `${items.length} place${items.length===1?"":"s"}`;

        if(!items.length){
          if(placesListEl){
            placesListEl.innerHTML = `
              <div class="p-5 rounded-2xl border bg-zinc-50 text-sm text-zinc-500">
                No results in <b>My places</b>.
                <ul class="mt-2 space-y-1 text-zinc-500 text-xs">
                  <li>Clear folder/category filters</li>
                  <li>Turn off Shortlist / Must-do toggles</li>
                  <li>Use <b>Search Athens (Map)</b> and click <b>Add</b></li>
                </ul>
              </div>
            `;
          }
          return;
        }

        const grouped = new Map();
        for(const p of items){
          const key = p.folderId || "__none__";
          if(!grouped.has(key)) grouped.set(key, []);
          grouped.get(key).push(p);
        }

        const orderedFolderIds = [
          ...state.folders.map(f => f.id),
          ...Array.from(grouped.keys()).filter(id => !state.folders.some(f => f.id === id))
        ].filter((v, i, a) => a.indexOf(v) === i);

        const html = orderedFolderIds
          .filter(fid => grouped.has(fid))
          .map(fid => {
            const folderPlaces = grouped.get(fid) || [];
            const pinned = folderPlaces.filter(p => p.pinned);
            const rest = folderPlaces.filter(p => !p.pinned);

            const folderTitle = escapeHtml(folderName(fid));
            const countPinned = pinned.length;

            return `
              <div class="p-3.5 rounded-2xl border bg-white">
                <div class="flex items-start justify-between gap-2 mb-2">
                  <div class="min-w-0">
                    <div class="font-semibold text-sm truncate">${folderTitle}</div>
                    <div class="text-[11px] text-zinc-400 mt-0.5 font-medium">
                      ${folderPlaces.length} place${folderPlaces.length===1?"":"s"}
                      ${countPinned ? ` &bull; <span class="text-blue-600 font-semibold">${countPinned} pinned</span>` : ""}
                    </div>
                  </div>
                  ${countPinned ? `<span class="tag text-blue-600">Pinned first</span>` : ""}
                </div>

                ${pinned.length ? `
                  <div class="mb-2">
                    <div class="text-[11px] font-semibold text-blue-600 mb-1.5 uppercase tracking-wider">Must-do</div>
                    <div class="space-y-2">
                      ${pinned.map(placeCard).join("")}
                    </div>
                  </div>
                ` : ""}

                ${rest.length ? `
                  <div>
                    <div class="text-[11px] font-semibold text-zinc-400 mb-1.5 uppercase tracking-wider">Other</div>
                    <div class="space-y-2">
                      ${rest.map(placeCard).join("")}
                    </div>
                  </div>
                ` : ""}
              </div>
            `;
          })
          .join("");

        if(placesListEl) placesListEl.innerHTML = html;
      }

      /***********************
       *  TABS
       ***********************/
      document.querySelectorAll(".tabBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;

          document.querySelectorAll(".tabBtn").forEach(b => {
            b.className = "tabBtn flex-1 btn px-3 py-2 rounded-lg text-sm font-medium text-zinc-500 hover:text-zinc-700";
          });
          btn.className = "tabBtn flex-1 btn px-3 py-2 rounded-lg bg-white text-sm font-medium shadow-sm text-zinc-900";

          document.getElementById("tab_places").classList.toggle("hidden", tab !== "places");
          document.getElementById("tab_readme").classList.toggle("hidden", tab !== "readme");

          const sb = document.getElementById("sidebar");
          if(sb) sb.scrollTo({ top: 0, behavior: "smooth" });

          setTimeout(() => map.invalidateSize(), 250);
        });
      });

      /***********************
       *  DROPDOWNS
       ***********************/
      function populateFilters(){
        ensureAtLeastOneFolder();
        if(filterFolderEl){
          filterFolderEl.innerHTML = `
            <option value="__all__">All folders</option>
            ${state.folders.map(f => `<option value="${escapeAttr(f.id)}">${escapeHtml(f.name)}</option>`).join("")}
          `;
        }
        if(filterCategoryEl){
          filterCategoryEl.innerHTML = `
            <option value="__all__">All categories</option>
            ${CATEGORIES.map(c => `<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join("")}
          `;
        }
      }

      function populateFormDropdowns(){
        ensureAtLeastOneFolder();

        const fCategory = document.getElementById("fCategory");
        const fFolder = document.getElementById("fFolder");

        if(fCategory){
          fCategory.innerHTML = CATEGORIES.map(c => `<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join("");
        }
        if(fFolder){
          fFolder.innerHTML = state.folders.map(f => `<option value="${escapeAttr(f.id)}">${escapeHtml(f.name)}</option>`).join("");
        }
      }

      /***********************
       *  MODAL (ADD/EDIT)
       ***********************/
      const modal = document.getElementById("modal");
      const modalTitle = document.getElementById("modalTitle");
      const btnCloseModal = document.getElementById("btnCloseModal");
      const btnSavePlace = document.getElementById("btnSavePlace");
      const btnDeletePlace = document.getElementById("btnDeletePlace");
      let editingPlaceId = null;

      function openModal(mode, place){
        ensureAtLeastOneFolder();
        populateFormDropdowns();

        modal.classList.remove("hidden");
        modal.classList.add("flex");

        editingPlaceId = place?.id || null;
        modalTitle.textContent = (mode === "edit") ? "Edit place" : "Add place";
        btnDeletePlace.classList.toggle("hidden", mode !== "edit");

        document.getElementById("fName").value = place?.name || "";
        document.getElementById("fCategory").value = place?.category || "Other";
        document.getElementById("fFolder").value = place?.folderId || state.folders[0]?.id;
        document.getElementById("fVibe").value = place?.vibe || "";
        document.getElementById("fLat").value = isFinite(place?.lat) ? place.lat : "";
        document.getElementById("fLng").value = isFinite(place?.lng) ? place.lng : "";
        document.getElementById("fDesc").value = place?.desc || "";
        document.getElementById("fLink").value = place?.link || "";
        document.getElementById("fGmaps").value = place?.gmaps || "";
        document.getElementById("fPhotos").value = (place?.photos || []).join(", ");
        document.getElementById("fFav").checked = !!place?.favorite;
        document.getElementById("fPinned").checked = !!place?.pinned;

        setTimeout(() => document.getElementById("fName").focus(), 50);
      }

      function closeModal(){
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        editingPlaceId = null;
      }

      btnCloseModal.addEventListener("click", closeModal);
      modal.addEventListener("click", (e) => { if(e.target === modal) closeModal(); });

      document.getElementById("btnAddPlace").addEventListener("click", () => openModal("add", null));

      window.openEdit = (id) => {
        const p = state.places.find(x => x.id === id);
        if(!p) return;
        openModal("edit", p);
      };

      btnSavePlace.addEventListener("click", () => {
        ensureAtLeastOneFolder();

        const place = {
          id: editingPlaceId || uid(),
          name: document.getElementById("fName").value.trim() || "Untitled",
          category: document.getElementById("fCategory").value,
          folderId: document.getElementById("fFolder").value,
          vibe: document.getElementById("fVibe").value.trim(),
          desc: document.getElementById("fDesc").value.trim(),
          lat: parseFloat(document.getElementById("fLat").value),
          lng: parseFloat(document.getElementById("fLng").value),
          link: document.getElementById("fLink").value.trim(),
          gmaps: document.getElementById("fGmaps").value.trim(),
          photos: document.getElementById("fPhotos").value.split(",").map(s => s.trim()).filter(Boolean),
          favorite: document.getElementById("fFav").checked,
          pinned: document.getElementById("fPinned").checked
        };

        if(!isFinite(place.lat) || !isFinite(place.lng)){
          alert("Please set a valid latitude/longitude (click the map, or paste coordinates).");
          return;
        }

        const idx = state.places.findIndex(x => x.id === place.id);
        if(idx >= 0) state.places[idx] = place;
        else state.places.push(place);

        touchState("Saved place");
        populateFilters();
        populateFormDropdowns();
        renderAll();
        closeModal();
      });

      btnDeletePlace.addEventListener("click", () => {
        if(!editingPlaceId) return;
        const p = state.places.find(x => x.id === editingPlaceId);
        if(!p) return;
        if(!confirm(`Delete "${p.name}"?`)) return;

        state.places = state.places.filter(x => x.id !== editingPlaceId);
        state.itinerary = state.itinerary.filter(e => e.placeId !== editingPlaceId);

        touchState("Deleted place");
        populateFilters();
        populateFormDropdowns();
        renderAll();
        closeModal();
      });

      /***********************
       *  HEARTS / PINS / VIEW
       ***********************/
      window.toggleFavorite = (id) => {
        const p = state.places.find(x => x.id === id);
        if(!p) return;
        p.favorite = !p.favorite;
        touchState(p.favorite ? "Added to shortlist" : "Removed from shortlist");
        renderAll();
      };

      window.togglePinned = (id) => {
        const p = state.places.find(x => x.id === id);
        if(!p) return;
        p.pinned = !p.pinned;
        touchState(p.pinned ? "Pinned as must-do" : "Unpinned");
        renderAll();
      };

      window.flyToPlace = (id) => {
        const p = state.places.find(x => x.id === id);
        if(!p || !isFinite(p.lat) || !isFinite(p.lng)) return;
        map.flyTo([p.lat, p.lng], 16, { duration: 0.8 });
        // On mobile, switch to map view
        if(window.innerWidth < 1024) hideSidebar();
        setTimeout(() => renderMarkers(), 250);
      };

      /***********************
       *  SEARCH + FILTER EVENTS
       ***********************/
      function styleToggleButtons(){
        if(state.ui.heartsOnly){
          btnOnlyHearts.classList.add("bg-red-50","border-red-300","text-red-700");
          btnOnlyHearts.classList.remove("bg-white","hover:bg-zinc-50");
        }else{
          btnOnlyHearts.classList.remove("bg-red-50","border-red-300","text-red-700");
          btnOnlyHearts.classList.add("bg-white","hover:bg-zinc-50");
        }

        if(state.ui.pinnedOnly){
          btnOnlyPinned.classList.add("bg-blue-50","border-blue-300","text-blue-700");
          btnOnlyPinned.classList.remove("bg-white","hover:bg-zinc-50");
        }else{
          btnOnlyPinned.classList.remove("bg-blue-50","border-blue-300","text-blue-700");
          btnOnlyPinned.classList.add("bg-white","hover:bg-zinc-50");
        }
      }

      filterFolderEl.addEventListener("change", () => renderAll());
      filterCategoryEl.addEventListener("change", () => renderAll());
      searchTextEl.addEventListener("input", () => renderAll());

      document.getElementById("btnClearSearch").addEventListener("click", () => {
        searchTextEl.value = "";
        renderAll();
        searchTextEl.focus();
      });

      btnOnlyHearts.addEventListener("click", () => {
        state.ui.heartsOnly = !state.ui.heartsOnly;
        touchState("Filter updated");
        styleToggleButtons();
        renderAll();
      });

      btnOnlyPinned.addEventListener("click", () => {
        state.ui.pinnedOnly = !state.ui.pinnedOnly;
        touchState("Filter updated");
        styleToggleButtons();
        renderAll();
      });

      document.addEventListener("keydown", (e) => {
        if(e.key === "Escape"){
          if(document.activeElement === searchTextEl || searchTextEl.value){
            searchTextEl.value = "";
            renderAll();
          }
          poiResultsEl.classList.add("hidden");
        }
        if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k"){
          e.preventDefault();
          poiQueryEl.focus();
        }
      });

      /***********************
       *  RESET
       ***********************/
      const btnReset = document.getElementById("btnReset");
      if(btnReset){
        btnReset.addEventListener("click", () => {
          if(!confirm("Reset EVERYTHING to defaults?")) return;
          state = normalizeState(null);
          touchState("Reset");
          initUI();
          renderAll();
          toast("Reset complete.");
        });
      }

      /***********************
       *  FOLDERS
       ***********************/
      const folderModal = document.getElementById("folderModal");
      const folderListEl = document.getElementById("folderList");

      document.getElementById("btnFolders").addEventListener("click", openFolderModal);
      document.getElementById("btnCloseFolderModal").addEventListener("click", closeFolderModal);
      folderModal.addEventListener("click", (e) => { if(e.target === folderModal) closeFolderModal(); });

      document.getElementById("btnAddFolder").addEventListener("click", () => {
        openFolderModal();
        document.getElementById("newFolderName").focus();
      });

      function openFolderModal(){
        folderModal.classList.remove("hidden");
        folderModal.classList.add("flex");
        renderFolderList();
      }
      function closeFolderModal(){
        folderModal.classList.add("hidden");
        folderModal.classList.remove("flex");
        document.getElementById("newFolderName").value = "";
      }

      function renderFolderList(){
        ensureAtLeastOneFolder();
        folderListEl.innerHTML = state.folders.map(f => {
          const count = state.places.filter(p => p.folderId === f.id).length;
          return `
            <div class="p-3.5 rounded-xl border bg-white flex items-center gap-3">
              <div class="min-w-0 flex-1">
                <div class="font-semibold text-sm truncate">${escapeHtml(f.name)}</div>
                <div class="text-[11px] text-zinc-400 font-medium">${count} place${count===1?"":"s"}</div>
              </div>
              <button class="btn px-3 py-1.5 rounded-lg border text-xs font-medium hover:bg-zinc-50" onclick="window.renameFolder('${f.id}')">Rename</button>
              <button class="btn px-3 py-1.5 rounded-lg border text-xs font-medium text-red-600 hover:bg-red-50" onclick="window.askDeleteFolder('${f.id}')">Delete</button>
            </div>
          `;
        }).join("");
      }

      document.getElementById("btnCreateFolder").addEventListener("click", () => {
        const input = document.getElementById("newFolderName");
        const name = (input.value || "").trim();
        if(!name) return;

        if(state.folders.some(f => f.name.toLowerCase() === name.toLowerCase())){
          alert("A folder with that name already exists.");
          return;
        }

        state.folders.push({ id:"f_"+uid(), name });
        input.value = "";

        touchState("Folder created");
        populateFilters();
        populateFormDropdowns();
        renderFolderList();
        renderAll();
      });

      window.renameFolder = (folderId) => {
        const f = state.folders.find(x => x.id === folderId);
        if(!f) return;
        const newName = prompt("New folder name:", f.name);
        if(!newName) return;
        f.name = newName.trim();

        touchState("Folder renamed");
        populateFilters();
        populateFormDropdowns();
        renderFolderList();
        renderAll();
      };

      /***********************
       *  DELETE FOLDER FLOW
       ***********************/
      const deleteFolderModal = document.getElementById("deleteFolderModal");
      const delFolderNameEl = document.getElementById("delFolderName");
      const delMoveToEl = document.getElementById("delMoveTo");

      const btnCloseDeleteFolderModal = document.getElementById("btnCloseDeleteFolderModal");
      const btnCancelDeleteFolder = document.getElementById("btnCancelDeleteFolder");
      const btnConfirmDeleteFolder = document.getElementById("btnConfirmDeleteFolder");

      btnCloseDeleteFolderModal.addEventListener("click", closeDeleteFolderModal);
      btnCancelDeleteFolder.addEventListener("click", closeDeleteFolderModal);
      deleteFolderModal.addEventListener("click", (e) => { if(e.target === deleteFolderModal) closeDeleteFolderModal(); });

      let pendingDeleteFolderId = null;

      function openDeleteFolderModal(folderId){
        ensureAtLeastOneFolder();
        pendingDeleteFolderId = folderId;
        const f = state.folders.find(x => x.id === folderId);
        delFolderNameEl.textContent = f?.name || "Unknown";

        const otherFolders = state.folders.filter(x => x.id !== folderId);
        if(otherFolders.length === 0){
          delMoveToEl.innerHTML = `<option value="__auto__">Auto-create "My places"</option>`;
        }else{
          delMoveToEl.innerHTML = otherFolders
            .map(x => `<option value="${escapeAttr(x.id)}">${escapeHtml(x.name)}</option>`)
            .join("");
        }

        deleteFolderModal.classList.remove("hidden");
        deleteFolderModal.classList.add("flex");
      }

      function closeDeleteFolderModal(){
        pendingDeleteFolderId = null;
        deleteFolderModal.classList.add("hidden");
        deleteFolderModal.classList.remove("flex");
      }

      window.askDeleteFolder = (folderId) => openDeleteFolderModal(folderId);

      btnConfirmDeleteFolder.addEventListener("click", () => {
        const folderId = pendingDeleteFolderId;
        if(!folderId) return;

        let destId = delMoveToEl.value;
        const otherFolders = state.folders.filter(x => x.id !== folderId);

        if(otherFolders.length === 0 || destId === "__auto__"){
          const newFolder = { id:"f_my_"+uid(), name:"My places" };
          state.folders.push(newFolder);
          destId = newFolder.id;
        }

        state.places.forEach(p => { if(p.folderId === folderId) p.folderId = destId; });
        state.folders = state.folders.filter(x => x.id !== folderId);

        ensureAtLeastOneFolder();

        touchState("Folder deleted (places moved)");
        populateFilters();
        populateFormDropdowns();
        renderFolderList();
        renderAll();
        closeDeleteFolderModal();
      });

      /***********************
       *  POI SEARCH (Nominatim)
       ***********************/
      let poiResults = [];
      const poiMarkersById = new Map();

      function clearPoiResults(){
        poiResults = [];
        poiMarkersById.clear();
        poiLayer.clearLayers();
        poiResultsEl.classList.add("hidden");
        poiResultsEl.innerHTML = "";
        toast("Cleared map results.");
      }

      btnPoiClearEl.addEventListener("click", (e) => {
        e.preventDefault();
        clearPoiResults();
      });

      async function runPoiSearch(){
        const q = (poiQueryEl.value || "").trim();
        if(!q) return;

        poiResultsEl.classList.remove("hidden");
        poiResultsEl.innerHTML = `<div class="p-4 text-sm text-zinc-500">Searching Athens...</div>`;

        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=10&countrycodes=gr`;

        try{
          const res = await fetch(url, { headers: { "Accept":"application/json" } });
          const data = await res.json();

          if(!Array.isArray(data) || data.length === 0){
            poiResultsEl.innerHTML = `<div class="p-4 text-sm text-zinc-500">No results.</div>`;
            poiLayer.clearLayers();
            return;
          }

          poiResults = data.map((d, idx) => ({
            id: `poi_${idx}_${String(d.place_id || "")}`,
            name: (d.display_name || "Result").split(",")[0],
            display_name: d.display_name || "Result",
            lat: parseFloat(d.lat),
            lon: parseFloat(d.lon)
          })).filter(x => isFinite(x.lat) && isFinite(x.lon));

          poiLayer.clearLayers();
          poiMarkersById.clear();

          poiResults.forEach(r => {
            const m = L.circleMarker([r.lat, r.lon], {
              radius: 8,
              weight: 2,
              color: "#111",
              fillColor: "#10b981",
              fillOpacity: 0.5
            }).addTo(poiLayer);

            m.bindPopup(`
              <div style="width:260px;font-family:Inter,system-ui,sans-serif;">
                <div style="font-weight:600;font-size:14px;">${escapeHtml(r.name)}</div>
                <div style="font-size:11px;color:#71717a;margin-top:4px;">${escapeHtml(r.display_name)}</div>
                <div style="display:flex;gap:6px;margin-top:8px;">
                  <button style="padding:4px 10px;border-radius:8px;border:1px solid #e4e4e7;font-size:11px;background:#fff;cursor:pointer;" onclick="window.poiZoom('${r.id}')">Zoom</button>
                  <button style="padding:4px 10px;border-radius:8px;border:1px solid #e4e4e7;font-size:11px;background:#fff;cursor:pointer;" onclick="window.poiAdd('${r.id}')">Add</button>
                </div>
              </div>
            `);

            poiMarkersById.set(r.id, m);
          });

          poiResultsEl.innerHTML = poiResults.map(r => `
            <div class="px-3.5 py-3 border-b last:border-b-0 hover:bg-zinc-50 transition-colors">
              <div class="flex items-start gap-2">
                <div class="min-w-0 flex-1">
                  <div class="text-sm font-semibold truncate">${escapeHtml(r.name)}</div>
                  <div class="text-[11px] text-zinc-500 line-clamp-2 mt-0.5">${escapeHtml(r.display_name)}</div>
                </div>
                <div class="flex gap-1.5 shrink-0">
                  <button class="btn px-2.5 py-1 rounded-lg border text-[11px] font-medium hover:bg-white" onclick="window.poiZoom('${r.id}')">Zoom</button>
                  <button class="btn px-2.5 py-1 rounded-lg bg-zinc-900 text-white text-[11px] font-medium" onclick="window.poiAdd('${r.id}')">Add</button>
                </div>
              </div>
            </div>
          `).join("");

          const first = poiResults[0];
          if(first) map.flyTo([first.lat, first.lon], 15, { duration: 0.8 });
          toast("Map results loaded.");
        }catch(e){
          poiResultsEl.innerHTML = `<div class="p-4 text-sm text-zinc-500">Search failed.</div>`;
        }
      }

      btnPoiEl.addEventListener("click", runPoiSearch);
      poiQueryEl.addEventListener("keydown", (e) => { if(e.key === "Enter") runPoiSearch(); });

      window.poiZoom = (poiId) => {
        const r = poiResults.find(x => x.id === poiId);
        if(!r) return;
        map.flyTo([r.lat, r.lon], 16, { duration: 0.8 });
        if(window.innerWidth < 1024) hideSidebar();
        const m = poiMarkersById.get(poiId);
        if(m) setTimeout(() => m.openPopup(), 350);
      };

      window.poiAdd = (poiId) => {
        const r = poiResults.find(x => x.id === poiId);
        if(!r) return;

        openModal("add", {
          name: r.name,
          category: "Other",
          folderId: state.folders[0]?.id,
          vibe: "",
          desc: "",
          lat: r.lat,
          lng: r.lon,
          link: "",
          gmaps: googleMapsLatLng(r.lat, r.lon),
          photos: [],
          favorite: false,
          pinned: false
        });

        toast("Ready to add pin (check details, then Save).");
      };

      /***********************
       *  RENDER ALL + INIT
       ***********************/
      function renderAll(){
        renderPlacesList();
        renderMarkers();
      }

      function initUI(){
        populateFilters();
        populateFormDropdowns();
        renderFolderList();
        styleToggleButtons();
      }

      /***********************
       *  CLOUD SYNC (Firebase)
       ***********************/
      let firebaseEnabled = false;
      let db = null;
      let tripDocRef = null;
      let lastUploadedUpdatedAt = 0;
      let isApplyingRemote = false;
      let saveTimer = null;

      function scheduleCloudSave(){
        if(!firebaseEnabled) return;
        if(isApplyingRemote) return;
        if(saveTimer) clearTimeout(saveTimer);
        saveTimer = setTimeout(() => { pushToCloud(); }, 800);
      }

      function touchState(message){
        state.meta = state.meta || { updatedAtMs: 0, updatedBy: "", tripId: TRIP_ID };
        state.meta.updatedAtMs = nowMs();
        state.meta.updatedBy = CLIENT_ID;
        state.meta.tripId = TRIP_ID;

        saveLocal();
        scheduleCloudSave();
        if(message) toast(message);
      }

      async function pushToCloud(){
        if(!firebaseEnabled || !db || !tripDocRef) return;

        const localUpdatedAt = state?.meta?.updatedAtMs || 0;
        if(localUpdatedAt <= lastUploadedUpdatedAt) return;

        setCloudUI("syncing", "Cloud: syncing...");

        try{
          await tripDocRef.set({
            tripId: TRIP_ID,
            updatedAtMs: localUpdatedAt,
            updatedBy: state.meta.updatedBy || CLIENT_ID,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            state
          }, { merge: true });

          lastUploadedUpdatedAt = localUpdatedAt;
          setCloudUI("on", "Cloud: synced");
        }catch(e){
          console.warn("pushToCloud failed:", e);
          setCloudUI("error", "Cloud: error");
        }
      }

      async function applyRemoteState(remote){
        if(!remote?.state) return;

        const remoteUpdatedAt = remote.updatedAtMs || 0;
        const localUpdatedAt = state?.meta?.updatedAtMs || 0;

        if(remoteUpdatedAt > localUpdatedAt){
          isApplyingRemote = true;
          try{
            state = normalizeState(remote.state);
            state.meta.updatedAtMs = remoteUpdatedAt;
            state.meta.updatedBy = remote.updatedBy || state.meta.updatedBy || "";
            saveLocal();

            initUI();
            renderAll();

            lastUploadedUpdatedAt = Math.max(lastUploadedUpdatedAt, remoteUpdatedAt);
            toast("Synced from cloud.");
          } finally {
            isApplyingRemote = false;
          }
        }
      }

      async function initFirebase(){
        try{
          setCloudUI("syncing", "Cloud: connecting...");

          if(firebase.apps && firebase.apps.length === 0){
            firebase.initializeApp(firebaseConfig);
          }else if(!firebase.apps){
            firebase.initializeApp(firebaseConfig);
          }

          const auth = firebase.auth();
          await auth.signInAnonymously();

          db = firebase.firestore();
          tripDocRef = db.collection("trips").doc(TRIP_ID);
          firebaseEnabled = true;

          setCloudUI("on", "Cloud: connected");

          const snap = await tripDocRef.get();
          if(snap.exists){
            await applyRemoteState(snap.data());
          } else {
            touchState(null);
            await pushToCloud();
          }

          tripDocRef.onSnapshot(async (snap2) => {
            if(!snap2.exists) return;
            const data2 = snap2.data();
            const remoteUpdatedAt = data2.updatedAtMs || 0;
            if(remoteUpdatedAt <= (state?.meta?.updatedAtMs || 0)) return;
            await applyRemoteState(data2);
          });

        }catch(e){
          console.warn("Firebase init failed:", e);
          setCloudUI("error", "Cloud: error");
        }
      }

      /***********************
       *  START
       ***********************/
      initUI();
      renderAll();
      setCloudUI("off", "Cloud: off");
      initFirebase();

    })();
  </script>
</body>
</html>
